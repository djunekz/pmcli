name: Build & Release pmcli Universal

on:
  push:
    tags:
      - 'v*.*.*'

jobs:
  build-universal:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3

      # Setup Rust
      - name: Setup Rust
        uses: actions-rs/toolchain@v1
        with:
          toolchain: stable
          override: true

      # Install cross crate untuk cross-compiling
      - name: Install cross
        run: cargo install cross

      # Build universal binary (static, vendored OpenSSL)
      - name: Build pmcli universal
        run: |
          # Ambil versi dari tag
          VERSION=${GITHUB_REF#refs/tags/}
          VERSION=${VERSION#v}

          # Buat direktori release
          mkdir -p release

          # Cross-build dengan vendored OpenSSL
          cross build --release --target x86_64-unknown-linux-gnu
          cross build --release --target aarch64-unknown-linux-gnu
          cross build --release --target x86_64-unknown-linux-musl
          cross build --release --target aarch64-unknown-linux-musl
          cross build --release --target armv7-linux-androideabi
          cross build --release --target aarch64-linux-android

          # Salin binary utama (misal target x86_64 host)
          cp target/release/pmcli release/pmcli

          # Buat tar.gz universal
          TAR="pmcli-$VERSION.tar.gz"
          TMP=$(mktemp -d)
          cp release/pmcli $TMP/pmcli
          tar -czvf release/$TAR -C $TMP pmcli
          rm -rf $TMP

  release:
    needs: build-universal
    runs-on: ubuntu-latest
    steps:
      - name: Upload universal tar.gz to GitHub Release
        uses: softprops/action-gh-release@v1
        with:
          files: release/*.tar.gz
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
